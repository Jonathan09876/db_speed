(function($){"use strict";var pluginName="kbModalAjax";var getPageScriptTags=function(){var scripts=[];jQuery("script[src]").each(function(){scripts.push(jQuery(this).attr("src"))});return scripts};var getPageCssLinks=function(){var links=[];jQuery('link[rel="stylesheet"]').each(function(){links.push(jQuery(this).attr("href"))});return links};function ModalAjax(element,options){this.element=element;this.init(options)}ModalAjax.prototype.init=function(options){this.selector=options.selector||null;this.initalRequestUrl=options.url;this.ajaxSubmit=options.ajaxSubmit;jQuery(this.element).on("show.bs.modal",this.shown.bind(this))};ModalAjax.prototype.shown=function(event){if(event.target!=this.element){return}var self=this;if(jQuery(this.element).hasClass("in")){return self}jQuery(this.element).find(".modal-body").html('<div class="modal-ajax-loader"></div>');jQuery.ajax({url:this.initalRequestUrl,context:this,beforeSend:function(xhr,settings){jQuery(self.element).triggerHandler("kbModalBeforeShow",[xhr,settings])},success:function(data,status,xhr){this.injectHtml(data);if(this.ajaxSubmit){jQuery(self.element).off("submit").on("submit",this.formSubmit.bind(this))}jQuery(self.element).triggerHandler("kbModalShow",[data,status,xhr,this.selector])},complete:function(xhr,textStatus){jQuery(self.element).triggerHandler("kbModalShowComplete",[xhr,textStatus])}})};ModalAjax.prototype.injectHtml=function(html){if(jQuery(this.element).find("form").length>0){jQuery(this.element).find("form").off().yiiActiveForm("destroy").remove()}jQuery(this.element).find(".modal-body").html(html);var knownScripts=getPageScriptTags();var knownCssLinks=getPageCssLinks();var newScripts=[];var inlineInjections=[];var loadedScriptsCount=0;var headTag=jQuery("head");if(headTag.length<1){headTag=jQuery("body");if(headTag.length<1){headTag=jQuery(document)}}jQuery(html).filter('link[rel="stylesheet"]').each(function(){var href=jQuery(this).attr("href");if(knownCssLinks.indexOf(href)<0){headTag.append(jQuery(this).prop("outerHTML"));knownCssLinks.push(href)}});jQuery(html).filter("script").each(function(){var src=jQuery(this).attr("src");if(typeof src==="undefined"){inlineInjections.push(jQuery(this).text())}else if(knownScripts.indexOf(src)<0){src+=src.indexOf("?")<0?"?":"&";newScripts.push(src)}});var scriptLoaded=function(){loadedScriptsCount+=1;if(loadedScriptsCount===newScripts.length){for(var i=0;i<inlineInjections.length;i+=1){window.eval(inlineInjections[i])}}};for(var i=0;i<newScripts.length;i+=1){jQuery.getScript(newScripts[i]+(new Date).getTime(),scriptLoaded)}};ModalAjax.prototype.formSubmit=function(){var form=jQuery(this.element).find("form");var self=this;if(form.attr("method")!=="GET"&&window.FormData!==undefined){jQuery.ajax({method:form.attr("method"),url:form.attr("action"),data:new FormData(form[0]),processData:false,contentType:false,context:this,beforeSend:function(xhr,settings){jQuery(self.element).triggerHandler("kbModalBeforeSubmit",[xhr,settings])},success:function(data,status,xhr){var contentType=xhr.getResponseHeader("content-type")||"";if(contentType.indexOf("html")>-1){this.injectHtml(data);status=false}jQuery(self.element).triggerHandler("kbModalSubmit",[data,status,xhr,this.selector])},complete:function(xhr,textStatus){jQuery(self.element).triggerHandler("kbModalSubmitComplete",[xhr,textStatus])}})}else{jQuery.ajax({method:form.attr("method"),url:form.attr("action"),data:form.serialize(),context:this,beforeSend:function(xhr,settings){jQuery(self.element).triggerHandler("kbModalBeforeSubmit",[xhr,settings])},success:function(data,status,xhr){var contentType=xhr.getResponseHeader("content-type")||"";if(contentType.indexOf("html")>-1){this.injectHtml(data);status=false}jQuery(self.element).triggerHandler("kbModalSubmit",[data,status,xhr,this.selector])},complete:function(xhr,textStatus){jQuery(self.element).triggerHandler("kbModalSubmitComplete",[xhr,textStatus])}})}return false};$.fn[pluginName]=function(options){return this.each(function(){if(!$.data(this,pluginName)){$.data(this,pluginName,new ModalAjax(this,options))}else{$.data(this,pluginName).initalRequestUrl=options.url;$.data(this,pluginName).selector=options.selector||null}})}})(jQuery);function modalUrl(url,json){var mUrl=url;mUrl+=mUrl.indexOf("?")===-1?"?":"&";if(json){mUrl+=$.param(json)}return mUrl}